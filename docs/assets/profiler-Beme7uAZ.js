import{R as z,p as K,Z as Q,_ as X,$ as Z,a0 as $,a1 as b,w as P,a2 as q,a3 as g,a4 as W,Q as Y,O as x,l as ee,a5 as te,a6 as ne}from"./index-BPXj25f5.js";function se(e){let n=0;for(const i of e)i.stackId!==void 0&&n++;return n}const h=new Map;function re(e,n){h.set(n,e)}function oe(e){return h.get(e)}function _(e){for(const n of h.keys())n<e&&h.delete(n)}function ae({rawRumEvent:e,startTime:n}){if(e.type!==z.LONG_TASK)return;const i=e.long_task.id;re(i,n)}const ie=(e,n,i)=>{const{profilingEndpointBuilder:r,applicationId:l}=n,p=le(e,n,i),c=ue(e,p),m=r.build("fetch",c);return K("Sending profile to public profiling intake",{profilingIntakeURL:m,applicationId:l,sessionId:i}),fetch(m,{body:c.data,method:"POST"})};function le(e,n,i){const r=Q(n),l=de(e,n.applicationId,i),p=ce(r);return{...l,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:p.join(","),_dd:{clock_drift:X()}}}function ce(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}function ue(e,n){const i=new Blob([JSON.stringify(e)],{type:"application/json"}),r=new FormData;return r.append("event",new Blob([JSON.stringify(n)],{type:"application/json"}),"event.json"),r.append("wall-time.json",i,"wall-time.json"),{data:r,bytesCount:0}}function de(e,n,i){const r={application:{id:n}};i&&(r.session={id:i});const l=Array.from(new Set(e.views.map(c=>c.viewId)));l.length&&(r.view={id:l});const p=e.longTasks.map(c=>c.id).filter(c=>c!==void 0);return p.length&&(r.long_task={id:p}),r}const pe={sendProfile:ie},fe=/\/(?![vV]\d{1,2}\/)([^/\d?]*\d+[^/?]*)/g;function me(e){return e?e.replace(fe,"/?"):"/"}const O=(e,n)=>e||me(n),ve={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function ge(e,n,i,r,l=ve){const p=Z($.LONG_ANIMATION_FRAME);let c;const m=[];let o={state:"stopped"};function L(t){o.state!=="running"&&(c=t?{startClocks:t.startClocks,viewId:t.id,viewName:O(t.name,document.location.pathname)}:void 0,m.push(P(e,window,"visibilitychange",A).stop,P(e,window,"beforeunload",j).stop),v())}async function N(){await k("stopped"),m.forEach(t=>t()),_(b().relative),r.set({status:"stopped",error_reason:void 0})}function D(t){if(t.state==="running")return{cleanupTasks:t.cleanupTasks,observer:t.observer};const s=[];let a;if(e.trackLongTasks){a=new PerformanceObserver(R),a.observe({entryTypes:[B()]});const u=n.subscribe(12,f=>{ae(f)});s.push(()=>a?.disconnect()),s.push(u.unsubscribe)}const d=n.subscribe(2,u=>{const f={viewId:u.id,viewName:O(u.name,document.location.pathname),startClocks:u.startClocks};y(f),c=f});return s.push(d.unsubscribe),{cleanupTasks:s,observer:a}}function v(){const t=q().Profiler;if(!t)throw r.set({status:"error",error_reason:"not-supported-by-browser"}),new Error("RUM Profiler is not supported in this browser.");T(o).catch(g);const{cleanupTasks:s,observer:a}=D(o);let d;try{d=new t({sampleInterval:l.sampleIntervalMs,maxBufferSize:Math.round(l.collectIntervalMs*1.5/l.sampleIntervalMs)})}catch(u){u instanceof Error&&u.message.includes("disabled by Document Policy")?(W.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",u),r.set({status:"error",error_reason:"missing-document-policy-header"})):r.set({status:"error",error_reason:"unexpected-exception"});return}r.set({status:"running",error_reason:void 0}),o={state:"running",startClocks:b(),profiler:d,timeoutId:Y(v,l.collectIntervalMs),longTasks:[],views:[],cleanupTasks:s,observer:a},y(c),d.addEventListener("samplebufferfull",w)}async function T(t){var s,a;if(t.state!=="running")return;E((a=(s=t.observer)===null||s===void 0?void 0:s.takeRecords())!==null&&a!==void 0?a:[]),x(t.timeoutId),t.profiler.removeEventListener("samplebufferfull",w);const{startClocks:d,longTasks:u,views:f}=t,V=b();await t.profiler.stop().then(I=>{const S=b(),G=u.length>0,H=ee(d.timeStamp,S.timeStamp)<l.minProfileDurationMs,J=se(I.samples)<l.minNumberOfSamples;!G&&(H||J)||(M(Object.assign(I,{startClocks:d,endClocks:S,clocksOrigin:te(),longTasks:u,views:f,sampleInterval:l.sampleIntervalMs})),_(V.relative))}).catch(g)}async function k(t){o.state==="running"&&(o.cleanupTasks.forEach(s=>s()),await T(o),o={state:t})}function y(t){o.state!=="running"||!t||o.views.push(t)}function M(t){var s;const a=(s=i.findTrackedSession())===null||s===void 0?void 0:s.id;pe.sendProfile(t,e,a).catch(g)}function w(){v()}function R(t){E(t.getEntries())}function E(t){if(o.state==="running")for(const s of t){if(s.duration<l.sampleIntervalMs)continue;const a=ne(s.startTime),d=oe(a.relative);o.longTasks.push({id:d,duration:s.duration,entryType:s.entryType,startClocks:a})}}function A(){document.visibilityState==="hidden"&&o.state==="running"?k("paused").catch(g):document.visibilityState==="visible"&&o.state==="paused"&&v()}function j(){v()}function B(){return p?"long-animation-frame":"longtask"}function C(){return o.state==="stopped"}function F(){return o.state==="running"}function U(){return o.state==="paused"}return{start:L,stop:N,isStopped:C,isRunning:F,isPaused:U}}export{ve as DEFAULT_RUM_PROFILER_CONFIGURATION,ge as createRumProfiler};
